<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="aha-table.html">
<link rel="import" href="px-data-table-column.html"> <!-- don't want users to have to import table-column as well as table -->

<!--
Element that defines a data table, optionally using a sub-element for advanced column settings.

##### Usage

    <px-data-table table-data="{{data}}"></px-data-table>

    <px-data-table filterable selectable table-data="{{data}}"></px-data-table>

    <px-data-table selected="{{selectedItems}}" filterable selectable striped table-data="{{data}}">
      <px-data-table-column name="first"
        type="string"
    		sortable
    		searchable
    		required
    		default=""
        filter-function-name="filterWholeWord"
        sort-function-name="sortColumn"
    		hint="Meaningful title will help you remember">
      </px-data-table-column>
      <px-data-table-column name="last" ...></px-data-table-column>
      <px-data-table-column name="color" ...></px-data-table-column>
      <px-data-table-column name="date" ...></px-data-table-column>
    </px-data-table>

@demo demo.html
-->
<dom-module id="px-data-table">
  <link rel="import" type="css" href="css/px-data-table.css" />

  <template>
    <div class="flex">
      <aha-table  searchable="{{filterable}}"
                  striped="{{striped}}"
                  table-columns="{{tableColumns}}"
                  table-rows="{{tableRows}}"
                  selectable="{{selectable}}"
                  selected-rows="{{selected}}"
                  meta="{{meta}}"
                  id="dataTable">
      </aha-table>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'px-data-table',

    properties: {

      /**
       * Data for the table to display.
       *
       * Expected data format is just a json array.  Each object in the array represents a row in the table.
       *
       *     [
       *       {
       *        "index": 0,
       *        "name": "Liz Grimes",
       *        "image": "https://s3.amazonaws.com/uifaces/faces/twitter/enda/73.jpg",
       *        "date": "Sun Aug 14 1994 03:27:03 GMT-0700 (PDT)"
       *      },
       *      {
       *        "index": 1,
       *        "name": "Frazier Lara",
       *        "image": "https://s3.amazonaws.com/uifaces/faces/twitter/guillogo/73.jpg",
       *        "date": "Tue May 24 1988 14:10:20 GMT-0700 (PDT)",
       *      }
       *    ]
       */
      tableData: {
        type: Array,
        value: function(){
          return [];
        },
        observer: '_tableDataChanged',
        notify: true,
        reflectToAttribute: true
      },


      /**
       * Use the striped attribute if the table rows are striped
       *
       *      <px-data-table striped table-data="{{data}}"></px-data-table>
       *
       * @default false
       */
			striped: {
				type: Boolean,
				value: false
			},

      /**
       * Use the filterable attribute if the table has filtering functionality per column turned on.
       *
       *      <px-data-table filterable table-data="{{data}}"></px-data-table>
       *
       * @default false
       */
      filterable: {
				type: Boolean,
				value: false
			},

      /**
       * Use the table-columns attribute if the table should be displayed as columns, instead of a grid.
       *
       *      <px-data-table table-columns table-data="{{data}}"></px-data-table>
       *
       * @default false
       */
      tableColumns: {
				type: Boolean,
				value: false
			},

      /**
       * Use the table-rows attribute if the table should be displayed as rows, instead of a grid.
       *
       *      <px-data-table table-rows table-data="{{data}}"></px-data-table>
       *
       * @default false
       */
      tableRows: {
				type: Boolean,
				value: false
			},

      /**
       * Use the selectable attribute if the table rows should be able to be selected.
       *
       *      <px-data-table selectable table-data="{{data}}"></px-data-table>
       *
       * @default false
       */
      selectable: {
				type: Boolean,
				value: false
			},

      /**
       * Selected rows in the data table setup for binding.
       */
      selected: {
				type: Array,
				value: function(){
          return [];
        },
        notify: true,
        reflectToAttribute: true
			}

    },
    ready: function(){
      var children = Polymer.dom(this).querySelectorAll('px-data-table-column');

			if (children.length > 0) {
				var meta = [];
				for (var i = 0; i < children.length; i++) {
					var column = {};
					for (var j = 0; j < children[i].attributes.length; j++) {
						var attribute = children[i].attributes[j];
						if (['sortable', 'searchable', 'editable', 'required'].indexOf(attribute.name) >= 0) {
							column[attribute.nodeName] = true;
						} else if (attribute.name === 'data-choices') {
							column['options'] = [];
							var choices = JSON.parse(attribute.value);
							for(option in choices) {
								column['options'].push({'value': option, 'label': choices[option]});
							}
						} else {
							column[attribute.nodeName] = attribute.value;
						}
						if (!column['label']) {
							var name = column['name'] || '';
							column['label'] = name.charAt(0).toUpperCase() + name.slice(1);
						}
					}
					meta.push(column);
				}
				this.set('meta', meta);
			}
    },
    _tableDataChanged: function(changeRecord){
      this.$.dataTable.data = this.tableData;
    },
    filterButtonClicked: function(){
      // this.filterable = !this.filterable;
    },
    _getColumns: function(){
      return Polymer.dom(this).children;
    }
  });
</script>
