<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../px-tooltip/px-tooltip.html">
<link rel="import" href="px-edit-cell.html">

<dom-module id="px-data-table-cell">
  <link rel="import" type="css" href="css/px-data-table-cell.css"/>
  <template>
    <span class$="{{_getReaderClass()}}">
      <!-- selected column checkbox -->
      <template is="dom-if" if="{{_isEqual(cellType, 'selected')}}">
        <span class="flex flex--center flex--middle">
          <input type="checkbox"
                 checked="{{internalRow._selected::change}}"/>
        </span>
      </template>

      <!-- in place editing template -->
      <px-edit-cell id="celledit" class="cell--edit visuallyhidden">
        <template is="dom-if" if="{{_isEqual(cellType, 'string')}}">
          <input type="text" class="u-p0 text-input text-input--bare" required$="{{column.required}}" on-blur="saveCell" value="{{cellValue}}" />
        </template>
        <template is="dom-if" if="{{_isEqual(cellType, 'text')}}">
          <textarea required$="{{column.required}}" on-blur="saveCell">{{cellValue}}</textarea>
        </template>
      </px-edit-cell>
      <!-- in place editing template -->

      <template is="dom-if" if="{{_isEqual(cellType,'string')}}">
        <span id="cellvalue" class="cell--value">{{cellDisplayValue}}
          <template is="dom-if" if="{{cellDisplayTooltip}}">
            <px-tooltip
              orientation="top"
              smart-orientation
              delay="1000"
              tooltip-message="{{cellValue}}">
            </px-tooltip>
          </template>
          <!-- <span><i class="fa-pull-right fa fa-exclamation-circle"></i></span> -->
        </span>
      </template>
    </span>
    <!-- html content -->
    <template is="dom-if" if="{{_isEqual(cellType,'html')}}">
      <aha-html-echo html="{{cellDisplayValue}}"></aha-html-echo>
    </template>
  </template>
  <script>
    Polymer({
      is: 'px-data-table-cell',
      properties: {
        cellType: {
          type: String,
          value: ''
        },
        cellDisplayValue: {
          type: String,
          value: '',
          observer: '_cellDisplayValueChanged'
        },
        cellValue: {
          type: String,
          value: ''
        },
        cellDisplayTooltip: {
          type: Boolean,
          value: false
        },
        cellValidation: {
          type: Object,
          value: function(){
            return {};
          },
          observer: '_cellValidityChanged'
        },
        columnName: {
          type: String,
          value: ''
        },

      },
      _cellDisplayValueChanged: function(newValue){
        if(this.$$('.cell--value') !== undefined){
          if (newValue !== undefined && newValue !== '') {
            this.$$('.cell--value').classList.remove('empty');
          } else {
            this.$$('.cell--value').classList.add('empty');
          }
        }
      },
      _isEqual: function(source, target) {
        return source === target;
      },
      _getCellClass: function(name) {
        return ['td ', 'aha-', name, '-td'].join('');
      },
      _getReaderClass: function() {
        var datum = this.cellValue,
            classList = ['viewing'];
        if(datum === null || datum === undefined || typeof datum === 'string' && datum.trim().length === 0) {
          classList.push('empty');
        }
        return classList.join(' ');
      },
      ready: function(){
        this.addEventListener('exit-edit-mode', this._exitEditMode.bind(this));
        this.addEventListener('undo-edit-mode', this._undoEditMode.bind(this));
        this.toggleClass('td', true);
        this.toggleClass('aha-' + this.columnName + 'td', true);
      },
      _exitEditMode: function(){
        document.activeElement.blur();
      },
      _undoEditMode: function(evt){
        this.set('_cancelSave', true);
        document.activeElement.blur();
      },
      editCell: function(){
        var editCell = this.$$(".cell--edit"),
            valueCell = this.$$(".cell--value");
        this.toggleClass('visuallyhidden', true, valueCell);
  			this.toggleClass('visuallyhidden', false, editCell);
        this.set('_undoValue', this.$$(".cell--value").innerText);

        Polymer.dom(editCell).querySelector('input,select,textarea').focus();
      },
      saveCell: function(evt){
        var value;
        if(this._cancelSave === true){
          this.set('_cancelSave', false);
          value = this._undoValue;
        }
        else {
          value = evt.target.value;
        }

        this.fire('save', {newValue: value});
				this.toggleClass('visuallyhidden', true, this.$$(".cell--edit"));
				this.toggleClass('visuallyhidden', false, this.$$(".cell--value"));
      },
      _cellValidityChanged: function(){
        // var editCellEl = evt.path.find(function(el) {
        //   return el.classList.contains('td') ? true : false;
        // });

        // this.toggleClass('cell--validation-failed', !passed, editCellEl);
        // this.toggleClass('cell--validation-failed', !passed, editCellEl);
        // this.toggleClass('icon', !passed, Polymer.dom(editCellEl).querySelector(".px-edit-cell-icon"));
        // this.toggleClass('fa', !passed, Polymer.dom(editCellEl).querySelector(".px-edit-cell-icon"));
        // this.toggleClass('fa-exclamation-circle', !passed, Polymer.dom(editCellEl).querySelector(".px-edit-cell-icon"));
        // px-edit-cell-icon
        // this.toggleClass('fa', !passed, editCellEl);
        // this.toggleClass('fa-exclamation-circle', !passed, editCellEl);

      }
    });
  </script>
</dom-module>

<!--
/**
 * @module aha-html-echo
 *
 *
 * Generates html elements dynamically, inspired by sortable-table
 * https://github.com/stevenrskelton/sortable-table
 *
 * WARNING! Potential XSS vulnerability if `html` comes from an untrusted source
 *
 *    <aha-html-echo
 *         html="html">
 *    </aha-html-echo>
 *
 * @class aha-html-echo
 * @author Michael Heinrichs<michael.heinrichs@canoo.com>
 *
 */
-->
<script>
  Polymer({
    is: "aha-html-echo",
    properties: {
      //column name
      html: {
        type: String,
        value: "",
        observer: "onHtmlChanged"
      }
    },
    onHtmlChanged: function() {
      if (!this.html) {
        this.html = "";
      }
      this.innerHTML = this.html;
    }
  });
</script>
